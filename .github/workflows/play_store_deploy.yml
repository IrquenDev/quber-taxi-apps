name: Android Build and Distribute

on:
  workflow_dispatch:
    inputs:
      flavor:
        description: "Flavor to build and deploy"
        required: true
        type: choice
        options:
          - client
          - driver
          - admin
        default: client

jobs:
  version:
    name: Create version number
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.gitversion.outputs.nuGetVersion }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v0.10.2
        with:
          versionSpec: "5.x"

      - name: Use GitVersion
        id: gitversion
        uses: gittools/actions/gitversion/execute@v0.10.2

      - name: Create version.txt with nuGetVersion
        run: echo "${{ steps.gitversion.outputs.nuGetVersion }}" > version.txt

      - name: Verify version.txt
        run: |
          pwd && ls -l 
          echo "Version: ${{ steps.gitversion.outputs.nuGetVersion }}"
          cat version.txt
      - name: Upload version.txt
        uses: actions/upload-artifact@v4
        with:
          name: gitversion
          path: ./version.txt
          overwrite: true

  build:
    name: Create Android Build
    needs: version
    runs-on: ubuntu-latest
    env:
      FLAVOR: ${{ github.event.inputs.flavor }}
    steps:
      - name: Set Package Name based on Flavor
        id: package_name
        run: |
          case "${{ github.event.inputs.flavor }}" in
            client)
              PACKAGE_NAME="com.irquen.quber_taxi"
              ;;
            driver)
              PACKAGE_NAME="com.irquen.quber_taxi.driver"
              ;;
            admin)
              PACKAGE_NAME="com.irquen.quber_taxi.admin"
              ;;
            *)
              echo "Error: Unknown flavor ${{ github.event.inputs.flavor }}"
              exit 1
              ;;
          esac
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "Package Name: $PACKAGE_NAME"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version.txt
        uses: actions/download-artifact@v4
        with:
          name: gitversion

      - name: Read version from file
        id: version
        run: |
          VERSION=$(tr -d '\n' < ./version.txt)
          echo "content=$VERSION" >> $GITHUB_OUTPUT
          echo "Version read: $VERSION"
      - name: Update version in YAML
        run: |
          sed -i "s/^version:.*/version: ${{ steps.version.outputs.content }}+${{ github.run_number }}/" pubspec.yaml
      - name: Download Android keystore
        id: android_keystore
        uses: timheuer/base64-to-file@v1.2
        with:
          fileName: "upload-keystore.jks"
          encodedString: "${{ secrets.RONNY_ANDROID_KEYSTORE_BASE64 }}"

      - name: Create key.properties
        run: |
          echo "storeFile=${{ steps.android_keystore.outputs.filePath }}" > android/key.properties
          echo "storePassword=${{ secrets.RONNY_ANDROID_KEYSTORE_PASSWORD }}" >> android/key.properties
          echo "keyPassword=${{ secrets.RONNY_ANDROID_KEYSTORE_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.RONNY_ANDROID_KEYSTORE_ALIAS }}" >> android/key.properties
          echo "Key properties created:"
          pwd
          ls -l ${{ steps.android_keystore.outputs.filePath }}
          ls -l android/key.properties
          echo "Verifying key.properties content:"
          cat android/key.properties
          echo "Verifying keystore file exists and is readable:"
          file ${{ steps.android_keystore.outputs.filePath }}
          keytool -list -v -keystore ${{ steps.android_keystore.outputs.filePath }} -storepass ${{ secrets.RONNY_ANDROID_KEYSTORE_PASSWORD }} | head -20

      #Modify to use your current project env variables
      - name: Create env files
        run: |
          mkdir -p env
          echo "targetEnvironment=prod" > env/.env
          echo "BASE_URL=${{ secrets.BASE_URL }}" > env/.env.prod
          echo "MAPBOX_ACCESS_TOKEN=${{ secrets.MAPBOX_ACCESS_TOKEN }}" >> env/.env.prod
          echo "Environment files created:"
          ls -la env/
          cat env/.env
          cat env/.env.prod
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"
          cache: gradle

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.x"
          channel: "stable"
          cache: true

      - name: Accept Android SDK licenses
        run: yes | flutter doctor --android-licenses

      - name: Install NDK r28 for 16KB page size compatibility
        run: |
          echo "Ensuring NDK r28.2.13676358 is available for 16KB page size compatibility..."
          NDK_VERSION="28.2.13676358"
          NDK_PATH="$ANDROID_HOME/ndk/$NDK_VERSION"

          # Check if NDK r28 is already installed
          if [ -d "$NDK_PATH" ]; then
            echo "NDK r28 already installed at $NDK_PATH"
          else
            echo "NDK r28 not found, installing..."
            # Find sdkmanager
            if [ -d "$ANDROID_HOME/cmdline-tools/latest" ]; then
              SDKMANAGER="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
            elif [ -d "$ANDROID_HOME/cmdline-tools" ]; then
              SDKMANAGER=$(find $ANDROID_HOME/cmdline-tools -name sdkmanager -type f | head -1)
            else
              echo "Error: sdkmanager not found"
              exit 1
            fi
            
            if [ -n "$SDKMANAGER" ] && [ -f "$SDKMANAGER" ]; then
              echo "Installing NDK $NDK_VERSION using $SDKMANAGER"
              yes | $SDKMANAGER "ndk;$NDK_VERSION" || {
                echo "Failed to install NDK via sdkmanager, Gradle will download it automatically during build"
              }
            else
              echo "sdkmanager not found, Gradle will download NDK automatically during build"
            fi
          fi

          # Verify installation
          if [ -d "$NDK_PATH" ]; then
            echo "✓ NDK r28 successfully available at $NDK_PATH"
          else
            echo "⚠ NDK r28 not found locally, Gradle will download it during build (this may take longer)"
          fi

          # Remove NDK 26 to prevent Gradle from using it
          echo "Removing NDK 26.x versions to force use of NDK r28..."
          for ndk_dir in $ANDROID_HOME/ndk/26.*; do
            if [ -d "$ndk_dir" ]; then
              echo "Removing $ndk_dir..."
              rm -rf "$ndk_dir"
            fi
          done

          # DO NOT configure ndk.dir in local.properties
          # Let Gradle use ndkVersion from build.gradle (matching local build behavior)
          # NDK r28 will be forced in all subprojects via android/build.gradle
          echo "✓ NDK version will be forced via build.gradle (matching local build behavior)"

      - name: Get dependencies
        run: flutter pub get

      - name: Generate files
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Verify NDK r28 is configured
        run: |
          echo "Verifying NDK r28 configuration..."

          # Verify NDK 26 is not present
          if [ -d "$ANDROID_HOME/ndk/26.1.10909125" ]; then
            echo "⚠ WARNING: NDK 26.1.10909125 still present, removing..."
            rm -rf "$ANDROID_HOME/ndk/26.1.10909125"
          fi

          # Verify NDK r28 is present
          if [ ! -d "$ANDROID_HOME/ndk/28.2.13676358" ]; then
            echo "⚠ WARNING: NDK r28 not found, Gradle will download it"
          else
            echo "✓ NDK r28 verified at $ANDROID_HOME/ndk/28.2.13676358"
          fi

          echo "✓ NDK version will be forced via build.gradle in all subprojects (matching local build behavior)"

      - name: Build Android App Bundle (AAB)
        env:
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
        run: |
          flutter build appbundle --flavor ${{ env.FLAVOR }} --release
          echo "AAB Build completed. Checking output:"
          pwd
          ls -l build/app/outputs/bundle/${{ env.FLAVOR }}Release/app-${{ env.FLAVOR }}-release.aab

      - name: Verify AAB Signing
        run: |
          echo "Verifying AAB is signed with release keystore..."
          bundletool_version="1.15.6"
          wget -q https://github.com/google/bundletool/releases/download/${bundletool_version}/bundletool-all-${bundletool_version}.jar -O bundletool.jar
          java -jar bundletool.jar validate --bundle=build/app/outputs/bundle/${{ env.FLAVOR }}Release/app-${{ env.FLAVOR }}-release.aab
          echo "Checking signing certificate..."
          unzip -p build/app/outputs/bundle/${{ env.FLAVOR }}Release/app-${{ env.FLAVOR }}-release.aab META-INF/MANIFEST.MF | head -20
          echo "AAB validation completed successfully!"

      - name: Upload Android AAB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-release-aab
          path: build/app/outputs/bundle/${{ env.FLAVOR }}Release/app-${{ env.FLAVOR }}-release.aab
          retention-days: 30

      - name: Prepare Flavor Name for Debug Symbols Path
        id: flavor_cap
        run: |
          FLAVOR_CAP="$(echo ${{ env.FLAVOR }} | sed 's/^./\U&/')"
          echo "capitalized=$FLAVOR_CAP" >> $GITHUB_OUTPUT
          echo "Capitalized flavor: $FLAVOR_CAP"

      - name: Upload Debug Symbols
        uses: actions/upload-artifact@v4
        with:
          name: debug-symbols
          path: build/app/intermediates/merged_native_libs/${{ env.FLAVOR }}Release/merge${{ steps.flavor_cap.outputs.capitalized }}ReleaseNativeLibs/out/lib
          retention-days: 30

      - name: Upload Mapping File
        uses: actions/upload-artifact@v4
        with:
          name: mapping
          path: build/app/outputs/mapping/${{ env.FLAVOR }}Release/mapping.txt
          retention-days: 30

  deploy_playstore:
    name: Deploy to Google Play Store
    needs: [version, build]
    runs-on: ubuntu-latest
    env:
      FLAVOR: ${{ github.event.inputs.flavor }}
    steps:
      - name: Set Package Name based on Flavor
        id: package_name
        run: |
          case "${{ github.event.inputs.flavor }}" in
            client)
              PACKAGE_NAME="com.irquen.quber_taxi"
              ;;
            driver)
              PACKAGE_NAME="com.irquen.quber_taxi.driver"
              ;;
            admin)
              PACKAGE_NAME="com.irquen.quber_taxi.admin"
              ;;
            *)
              echo "Error: Unknown flavor ${{ github.event.inputs.flavor }}"
              exit 1
              ;;
          esac
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "Package Name: $PACKAGE_NAME"

      - name: Download Android AAB Artifact
        uses: actions/download-artifact@v4
        with:
          name: android-release-aab
          path: ./release

      - name: Download Debug Symbols
        uses: actions/download-artifact@v4
        with:
          name: debug-symbols
          path: ./release/debug-symbols

      - name: Download Mapping File
        uses: actions/download-artifact@v4
        with:
          name: mapping
          path: ./release

      - name: Download Version Artifact
        uses: actions/download-artifact@v4
        with:
          name: gitversion

      - name: Read version for release notes
        id: version
        run: |
          VERSION=$(tr -d '\n' < ./version.txt)
          echo "content=$VERSION" >> $GITHUB_OUTPUT
          echo "Version for Play Store: $VERSION"
      - name: Verify downloaded files
        run: |
          echo "Current directory contents:"
          ls -la
          echo "Release directory contents:"
          ls -la ./release/
          echo "Checking AAB:"
          ls -l ./release/*.aab
          echo "Checking mapping file:"
          ls -l ./release/mapping.txt
          echo "Checking debug symbols:"
          ls -la ./release/debug-symbols/
      - name: Deploy to Google Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ steps.package_name.outputs.package_name }}
          releaseFiles: ./release/*.aab
          debugSymbols: ./release/debug-symbols
          mappingFile: ./release/mapping.txt
          # Available tracks: internal, alpha, beta, production
          # - internal: Internal testing (up to 100 testers)
          # - alpha: Closed testing alpha track
          # - beta: Open/closed testing beta track
          # - production: Production release for all users
          track: internal
          status: completed

      - name: Deployment Success Notification
        run: |
          echo "GOOGLE PLAY STORE DEPLOYMENT COMPLETED" >> $GITHUB_STEP_SUMMARY
          echo "================================================" >> $GITHUB_STEP_SUMMARY
          echo "Flavor: ${{ env.FLAVOR }}" >> $GITHUB_STEP_SUMMARY
          echo "Package: ${{ steps.package_name.outputs.package_name }}" >> $GITHUB_STEP_SUMMARY
          echo "Version: ${{ steps.version.outputs.content }}+${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "Track: internal (Internal Testing)" >> $GITHUB_STEP_SUMMARY
          echo "Status: completed" >> $GITHUB_STEP_SUMMARY
          echo "Build Date: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "================================================"
